<!DOCTYPE html>
<html>
<head>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, child, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyDwMCTIK38vlLLAHByz0MRWz4FgeXhMh6g",
      authDomain: "github-belanja-bulanext.firebaseapp.com",
      databaseURL: "https://github-belanja-bulanext-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "github-belanja-bulanext",
      storageBucket: "github-belanja-bulanext.firebasestorage.app",
      messagingSenderId: "718219974978",
      appId: "1:718219974978:web:30505728a4806d857d10db"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
  
    async function checkAuth() {
      const token = sessionStorage.getItem("authToken");
      if (!token) {
        window.location.href = "login.html";
        return;
      }
      const snapshot = await get(child(ref(db), "auth/" + token));
      if (!snapshot.exists()) {
        sessionStorage.removeItem("authToken");
        window.location.href = "login.html";
        return;
      }
      const tokenData = snapshot.val();
      if (Date.now() - tokenData.createdAt > 10800000) {
        sessionStorage.removeItem("authToken");
        window.location.href = "login.html";
      }
    }
  
    await checkAuth();
  
    const itemsRef = ref(db, "shoppingList");
  
    onValue(itemsRef, (snapshot) => {
      const ul = document.getElementById("keranjang");
      ul.innerHTML = "";
      snapshot.forEach((childSnapshot) => {
        const li = document.createElement("li");
        li.textContent = childSnapshot.val().name;
        li.style.position = "relative";
        li.style.padding = "8px 12px";
        li.style.userSelect = "none";
  
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "X";
        deleteBtn.className = "btn btn-sm btn-danger";
        deleteBtn.style.position = "absolute";
        deleteBtn.style.right = "10px";
        deleteBtn.style.top = "50%";
        deleteBtn.style.transform = "translateY(-50%)";
        deleteBtn.onclick = () => remove(ref(db, "shoppingList/" + childSnapshot.key));
        li.appendChild(deleteBtn);
  
        let startX = 0;
        let currentX = 0;
        let dragging = false;
  
        function startDrag(e) {
          dragging = true;
          startX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
          li.style.transition = "";
        }
  
        function dragMove(e) {
          if (!dragging) return;
          currentX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
          const dx = currentX - startX;
          li.style.transform = `translateX(${dx}px)`;
        }
  
        function endDrag() {
          if (!dragging) return;
          dragging = false;
          const dx = currentX - startX;
          if (Math.abs(dx) > 100) remove(ref(db, "shoppingList/" + childSnapshot.key));
          else li.style.transition = "transform 0.2s";
          li.style.transform = "translateX(0)";
        }
  
        li.addEventListener("mousedown", startDrag);
        li.addEventListener("mousemove", dragMove);
        li.addEventListener("mouseup", endDrag);
        li.addEventListener("mouseleave", endDrag);
        li.addEventListener("touchstart", startDrag);
        li.addEventListener("touchmove", dragMove);
        li.addEventListener("touchend", endDrag);
  
        ul.appendChild(li);
      });
    });
  
    window.addItem = function() {
      const input = document.getElementById("daftar");
      const text = input.value.trim();
      if (text === "") return;
      push(itemsRef, { name: text });
      input.value = "";
    };
  
    const input = document.getElementById("daftar");
    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        addItem();
      }
    });
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv='cache-control' content='no-cache'> 
  <meta http-equiv='expires' content='0'> 
  <meta http-equiv='pragma' content='no-cache'>
  <meta name="description" content="A feature to show shopping list">
  <meta name="title" content="Belanja Bulanext">
  <title>Belanja Bulanext | Bona Muvid's Page</title>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="custom.css">
</head>
<body>
  <div class="mainwrapper">
    <h1>Belanja Bulanext</h1>
    <hr/>
    <div class="input-group mb-3">
      <input class="form-control" type="text" id="daftar" placeholder="Nama Barang" onclick="this.select()" style="margin: 5px;">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" id="tambahkan" onclick="addItem()" style="margin: 5px;">Tambahkan</button>
      </div>
    </div>
    <div>
      <ul id="keranjang"></ul>
    </div>
  </div>
</body>
</html>
